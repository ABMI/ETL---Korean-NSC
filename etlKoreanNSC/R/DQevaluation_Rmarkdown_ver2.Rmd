---
title: "NHIS_CDM_DQ"
author: "Young Jin Choi"
date: '2019 8 26 '
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### DQ Function  

```{r, echo=FALSE}
DQevaluation <- function(NHISNSC_rawdata,
                         NHISNSC_database,
                         Mapping_database,
                         NHIS_JK,
                         NHIS_20T,
                         NHIS_30T,
                         NHIS_40T,
                         NHIS_60T,
                         NHIS_GJ,

                         connection,
                         
                         drug_exposure = TRUE,
                         procedure_occurrence = TRUE,
                         device_exposure = TRUE,
                         condition_occurrence = TRUE,
                         measurement = TRUE
                         
                         
){
    
    
    ## Drug_exposure
    if(drug_exposure){
        
        ## Mapping Table
        SqlMapping <- c("
                        IF Object_id('tempdb..#mapping_table', 'U') IS NOT NULL 
                        DROP TABLE #mapping_table; 
                        SELECT a.source_code, a.target_concept_id, a.domain_id, Replace(a.invalid_reason, '', NULL) AS invalid_reason 
                        INTO   #mapping_table 
                        FROM   @Mapping_database.source_to_concept_map a 
                        JOIN @Mapping_database.concept b 
                        ON a.target_concept_id = b.concept_id 
                        WHERE  a.invalid_reason IS NULL 
                        AND b.invalid_reason IS NULL 
                        AND a.domain_id = 'drug';
                        ")
        SqlMapping <- SqlRender::render(SqlMapping,Mapping_database = Mapping_database)
        DatabaseConnector::executeSql(connection,SqlMapping)
        
        
        ## 30T Mappied
        SqlMappied30T <- c("
                           SELECT multimappied, Count(*) as count -- 104,292,115
                           FROM   (SELECT master_seq, Count(*) AS multimappied -- 104,292,115 
                           FROM   (SELECT master_seq, div_cd 
                           FROM   @NHISNSC_rawdata.@NHIS_30T x, 
                           (SELECT master_seq, person_id, key_seq, seq_no 
                           FROM   @NHISNSC_database.seq_master 
                           WHERE  source_table = '130') y, 
                           @NHISNSC_rawdata.@NHIS_20T z 
                           WHERE  x.key_seq = y.key_seq 
                           AND x.seq_no = y.seq_no 
                           AND y.key_seq = z.key_seq 
                           AND y.person_id = z.person_id) a, 
                           #mapping_table b 
                           WHERE  a.div_cd = b.source_code 
                           GROUP  BY master_seq) c 
                           GROUP  BY multimappied 
                           ")
        SqlMappied30T <- SqlRender::render(SqlMappied30T,
                                           NHISNSC_rawdata = NHISNSC_rawdata,
                                           NHISNSC_database = NHISNSC_database,
                                           NHIS_20T = NHIS_20T,
                                           NHIS_30T = NHIS_30T)
        ConvertedDrugCountByMappied30T <<- DatabaseConnector::querySql(connection,SqlMappied30T)
        
        ## 30T Unmappied
        SqlUnMappied30T <- c("
                             SELECT Count(*) as count-- 4,400,052
                             FROM   (SELECT master_seq, div_cd 
                             FROM   (SELECT * 
                             FROM   @NHISNSC_rawdata.@NHIS_30T 
                             WHERE  div_type_cd IN ( '3', '4', '5' )) x, 
                             (SELECT master_seq, person_id, key_seq, seq_no 
                             FROM   @NHISNSC_database.seq_master 
                             WHERE  source_table = '130') y, 
                             @NHISNSC_rawdata.@NHIS_20T z 
                             WHERE  x.key_seq = y.key_seq 
                             AND x.seq_no = y.seq_no 
                             AND y.key_seq = z.key_seq 
                             AND y.person_id = z.person_id) a 
                             WHERE  a.div_cd NOT IN (SELECT source_code 
                             FROM   #mapping_table)
                             ")
        SqlUnMappied30T <- SqlRender::render(SqlUnMappied30T,
                                             NHISNSC_rawdata = NHISNSC_rawdata,
                                             NHISNSC_database = NHISNSC_database,
                                             NHIS_20T = NHIS_20T,
                                             NHIS_30T = NHIS_30T)
        ConvertedDrugCountByUnMappied30T <<- DatabaseConnector::querySql(connection,SqlUnMappied30T)
        
        ## 30T Raw
        SqlRawToDrugBy30T_1 <- c("
                                 SELECT div_type_cd, multimappied, Count(*) AS count, 'Y' AS MAPPING_YN 
                                 FROM   (SELECT key_seq, seq_no, div_type_cd, Count(*) AS multimappied 
                                 FROM   (SELECT * 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_30T) a 
                                 JOIN #mapping_table b 
                                 ON a.div_cd = b.source_code) c -- 1:1 mapping  
                                 GROUP  BY key_seq, seq_no, div_type_cd) d 
                                 GROUP  BY div_type_cd, multimappied 
                                 ")
        SqlRawToDrugBy30T_1 <- SqlRender::render(SqlRawToDrugBy30T_1,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_30T = NHIS_30T)
        SqlRawToDrugBy30T_2 <- c("
                                 SELECT div_type_cd, 1 as multimappied, Count(*) as count, 'N' AS MAPPING_YN 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_30T 
                                 WHERE  div_type_cd IN ( '3', '4', '5' )
                                 AND    div_cd not in (select source_code from #mapping_table)) a
                                 GROUP by div_type_cd
                                 ")
        SqlRawToDrugBy30T_2 <- SqlRender::render(SqlRawToDrugBy30T_2,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_30T = NHIS_30T)
        HowManyContainDrugByMappied30T <- DatabaseConnector::querySql(connection,SqlRawToDrugBy30T_1)
        HowManyContainDrugByMappied30T <<- rbind(HowManyContainDrugByMappied30T,DatabaseConnector::querySql(connection,SqlRawToDrugBy30T_2))
        
        
        ## 60T Mappied
        SqlMappied60T <- c("
                           SELECT multimappied, Count(*) as count -- 384,321,194
                           FROM   (SELECT master_seq, Count(*) AS multimappied -- 
                           FROM   (SELECT master_seq, div_cd 
                           FROM   @NHISNSC_rawdata.@NHIS_60T x, 
                           (SELECT master_seq, person_id, key_seq, seq_no 
                           FROM   @NHISNSC_database.seq_master 
                           WHERE  source_table = '160') y, 
                           @NHISNSC_rawdata.@NHIS_20T z 
                           WHERE  x.key_seq = y.key_seq 
                           AND x.seq_no = y.seq_no 
                           AND y.key_seq = z.key_seq 
                           AND y.person_id = z.person_id) a, 
                           #mapping_table b 
                           WHERE  a.div_cd = b.source_code 
                           GROUP  BY master_seq) c 
                           GROUP  BY multimappied
                           ")
        SqlMappied60T <- SqlRender::render(SqlMappied60T,
                                           NHISNSC_rawdata = NHISNSC_rawdata,
                                           NHISNSC_database = NHISNSC_database,
                                           NHIS_20T = NHIS_20T,
                                           NHIS_60T = NHIS_60T)
        ConvertedDrugCountByMappied60T <<- DatabaseConnector::querySql(connection,SqlMappied60T)
        
        ## 60T Unmappied
        SqlUnMappied60T <- c("
                             SELECT Count(*) as count -- 
                             FROM   (SELECT master_seq, div_cd 
                             FROM   (SELECT * 
                             FROM   @NHISNSC_rawdata.@NHIS_60T 
                             WHERE  div_type_cd IN ( '3', '4', '5' )) x, 
                             (SELECT master_seq, person_id, key_seq, seq_no 
                             FROM   @NHISNSC_database.seq_master 
                             WHERE  source_table = '160') y, 
                             @NHISNSC_rawdata.@NHIS_20T z 
                             WHERE  x.key_seq = y.key_seq 
                             AND x.seq_no = y.seq_no 
                             AND y.key_seq = z.key_seq 
                             AND y.person_id = z.person_id) a 
                             WHERE  a.div_cd NOT IN (SELECT source_code 
                             FROM   #mapping_table) 
                             ")
        SqlUnMappied60T <- SqlRender::render(SqlUnMappied60T,
                                             NHISNSC_rawdata = NHISNSC_rawdata,
                                             NHISNSC_database = NHISNSC_database,
                                             NHIS_20T = NHIS_20T,
                                             NHIS_60T = NHIS_60T)
        ConvertedDrugCountByUnMappied60T <<- DatabaseConnector::querySql(connection,SqlUnMappied60T)
        
        ## 60T Raw
        SqlRawToDrugBy60T_1 <- c("
                                 SELECT div_type_cd, multimappied, Count(*) AS count, 'Y' AS MAPPING_YN 
                                 FROM   (SELECT key_seq, seq_no, div_type_cd, Count(*) AS multimappied 
                                 FROM   (SELECT * 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_60T) a 
                                 JOIN #mapping_table b 
                                 ON a.div_cd = b.source_code) c -- 1:1 mapping  
                                 GROUP  BY key_seq, seq_no, div_type_cd) d 
                                 GROUP  BY div_type_cd, multimappied
                                 ")
        SqlRawToDrugBy60T_1 <- SqlRender::render(SqlRawToDrugBy60T_1,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_60T = NHIS_60T)
        SqlRawToDrugBy60T_2 <- c("
                                 SELECT div_type_cd, 1 as multimappied, Count(*) as COUNT, 'N' AS MAPPING_YN 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_60T 
                                 WHERE  div_type_cd IN ( '3', '4', '5' )
                                 AND    div_cd not in (select source_code from #mapping_table)) a
                                 GROUP by div_type_cd
                                 ")
        SqlRawToDrugBy60T_2 <- SqlRender::render(SqlRawToDrugBy60T_2,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_60T = NHIS_60T)
        HowManyContainDrugByMappied60T <- DatabaseConnector::querySql(connection,SqlRawToDrugBy60T_1)
        HowManyContainDrugByMappied60T <<- rbind(HowManyContainDrugByMappied60T,DatabaseConnector::querySql(connection,SqlRawToDrugBy60T_2))
        
    } ## DrugTable : 20T join으로 인해 4건 차이남, Death기간으로 인해 delete 발생
    
    
    
    
    ## Procedure_occurrence
    if(procedure_occurrence){
        
        ## Mapping Table
        SqlMapping <- c("
                        IF OBJECT_ID('tempdb..#mapping_table', 'U') IS NOT NULL
                        DROP TABLE #mapping_table;
                        IF OBJECT_ID('tempdb..#temp', 'U') IS NOT NULL
                        DROP TABLE #temp;
                        IF OBJECT_ID('tempdb..#duplicated', 'U') IS NOT NULL
                        DROP TABLE #duplicated;
                        IF OBJECT_ID('tempdb..#pro', 'U') IS NOT NULL
                        DROP TABLE #pro;
                        IF OBJECT_ID('tempdb..#five', 'U') IS NOT NULL
                        DROP TABLE #five;
                        select a.source_code, a.target_concept_id, a.domain_id, REPLACE(a.invalid_reason, '', NULL) as invalid_reason
                        into #temp
                        from @Mapping_database.source_to_concept_map a join @Mapping_database.CONCEPT b on a.target_concept_id=b.concept_id
                        where a.invalid_reason is null and b.invalid_reason is null and a.domain_id='procedure';
                        
                        select * into #pro from @Mapping_database.source_to_concept_map where domain_id='procedure';
                        select * into #five from @Mapping_database.source_to_concept_map where domain_id='device';
                        
                        select a.*
                        into #duplicated
                        from #pro a, #five b
                        where a.source_code=b.source_code
                        and a.invalid_reason is null and b.invalid_reason is null;
                        
                        select * into #mapping_table from #temp
                        where source_code not in (select source_code from #duplicated);
                        
                        drop table #pro, #five, #temp;
                        ")
        SqlMapping <- SqlRender::render(SqlMapping,Mapping_database = Mapping_database)
        DatabaseConnector::executeSql(connection,SqlMapping)
        
        
        ## 30T Mappied
        SqlMappied30T <- c("
                           SELECT Count(*) as count -- 234,624,188
                           FROM   (SELECT x.div_cd, x.div_type_cd 
                           FROM   (SELECT * 
                           FROM   @NHISNSC_rawdata.@NHIS_30T 
                           WHERE  div_type_cd NOT IN ( '3', '4', '5', '7', '8' )) x, 
                           (SELECT * FROM   @NHISNSC_database.seq_master 
                           WHERE  source_table = '130') y 
                           WHERE  x.key_seq = y.key_seq 
                           AND x.seq_no = y.seq_no) a, 
                           #mapping_table b -- 1:n mappied
                           WHERE  LEFT(a.div_cd, 5) = b.source_code
                           ")
        SqlMappied30T <- SqlRender::render(SqlMappied30T,
                                           NHISNSC_rawdata = NHISNSC_rawdata,
                                           NHISNSC_database = NHISNSC_database,
                                           NHIS_30T = NHIS_30T)
        ConvertedProcCountByMappied30T <<- DatabaseConnector::querySql(connection,SqlMappied30T)
        
        ## 30T Dup Mappied
        SqlDupMappied30T <- c("
                              SELECT Count(*) as count -- 3,448,362 
                              FROM   (SELECT x.div_cd, x.div_type_cd 
                              FROM   (SELECT * 
                              FROM   @NHISNSC_rawdata.@NHIS_30T 
                              WHERE  div_type_cd IN ( '1', '2' )) x, 
                              (SELECT * FROM   @NHISNSC_database.seq_master 
                              WHERE  source_table = '130') y 
                              WHERE  x.key_seq = y.key_seq 
                              AND x.seq_no = y.seq_no) a, 
                              #duplicated b 
                              WHERE  LEFT(a.div_cd, 5) = b.source_code
                              ")
        SqlDupMappied30T <- SqlRender::render(SqlDupMappied30T,
                                              NHISNSC_rawdata = NHISNSC_rawdata,
                                              NHISNSC_database = NHISNSC_database,
                                              NHIS_30T = NHIS_30T)
        ConvertedProcCountByDupMappied30T <<- DatabaseConnector::querySql(connection,SqlDupMappied30T)
        
        ## 30T UnMappied
        SqlUnMappied30T <- c("
                             SELECT Count(*) as count -- 214,373,129
                             FROM   (SELECT x.div_cd, x.div_type_cd 
                             FROM   (SELECT * 
                             FROM   @NHISNSC_rawdata.@NHIS_30T 
                             WHERE  div_type_cd IN ( '1', '2' )) x, 
                             (SELECT *
                             FROM   @NHISNSC_database.seq_master 
                             WHERE  source_table = '130') y 
                             WHERE  x.key_seq = y.key_seq 
                             AND x.seq_no = y.seq_no) a 
                             WHERE  LEFT(a.div_cd, 5) NOT IN (SELECT source_code 
                             FROM   #duplicated 
                             UNION ALL 
                             SELECT source_code 
                             FROM   #mapping_table)
                             ")
        SqlUnMappied30T <- SqlRender::render(SqlUnMappied30T,
                                             NHISNSC_rawdata = NHISNSC_rawdata,
                                             NHISNSC_database = NHISNSC_database,
                                             NHIS_30T = NHIS_30T)
        ConvertedProcCountByUnMappied30T <<- DatabaseConnector::querySql(connection,SqlUnMappied30T)
        
        ## 30T Raw
        SqlRawToProcBy30T_1 <- c("
                                 SELECT div_type_cd, multimappied, Count(*) AS COUNT, 'Y' AS MAPPING_YN
                                 FROM   (SELECT key_seq, seq_no, div_type_cd, Count(*) AS multimappied 
                                 FROM   (SELECT * 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_30T 
                                 WHERE  div_type_cd NOT IN ( '3', '4', '5', '7', '8' )) a, #mapping_table b 
                                 WHERE  LEFT(a.div_cd, 5) = b.source_code) c 
                                 GROUP  BY key_seq, seq_no, div_type_cd) d 
                                 GROUP  BY div_type_cd, multimappied 
                                 ")
        SqlRawToProcBy30T_1 <- SqlRender::render(SqlRawToProcBy30T_1,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_30T = NHIS_30T)
        SqlRawToProcBy30T_2 <- c("
                                 SELECT div_type_cd, multimappied, Count(*) AS COUNT, 'Y' AS MAPPING_YN
                                 FROM   (SELECT key_seq, seq_no, div_type_cd, Count(*) AS multimappied 
                                 FROM   (SELECT * 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_30T 
                                 WHERE  div_type_cd IN ( '1', '2' )) a, #duplicated b 
                                 WHERE  LEFT(a.div_cd, 5) = b.source_code) c 
                                 GROUP  BY key_seq, seq_no, div_type_cd) d 
                                 GROUP  BY div_type_cd, multimappied 
                                 ")
        SqlRawToProcBy30T_2 <- SqlRender::render(SqlRawToProcBy30T_2,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_30T = NHIS_30T)
        SqlRawToProcBy30T_3 <- c("
                                 SELECT div_type_cd, multimappied, Count(*) AS COUNT, 'N' AS MAPPING_YN
                                 FROM   (SELECT key_seq, seq_no, div_type_cd, Count(*) AS multimappied 
                                 FROM   (SELECT * 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_30T 
                                 WHERE  div_type_cd IN ( '1', '2' )) a
                                 WHERE  LEFT(a.div_cd, 5) NOT IN (SELECT source_code FROM #duplicated UNION ALL SELECT source_code FROM #mapping_table)) c 
                                 GROUP  BY key_seq, seq_no, div_type_cd) d 
                                 GROUP  BY div_type_cd, multimappied 
                                 ")
        SqlRawToProcBy30T_3 <- SqlRender::render(SqlRawToProcBy30T_3,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_30T = NHIS_30T)
        HowManyContainProcByMappied30T <- DatabaseConnector::querySql(connection,SqlRawToProcBy30T_1)
        HowManyContainProcByMappied30T <- rbind(HowManyContainProcByMappied30T,DatabaseConnector::querySql(connection,SqlRawToProcBy30T_2))
        HowManyContainProcByMappied30T <<- rbind(HowManyContainProcByMappied30T,DatabaseConnector::querySql(connection,SqlRawToProcBy30T_3))
        
        
        ## 60T Mappied
        SqlMappied60T <- c("
                           SELECT Count(*) as count -- 8,785
                           FROM   (SELECT x.div_cd, x.div_type_cd 
                           FROM   (SELECT * 
                           FROM   @NHISNSC_rawdata.@NHIS_60T 
                           WHERE  div_type_cd NOT IN ( '3', '4', '5', '7', '8' )) x, 
                           (SELECT * 
                           FROM   @NHISNSC_database.seq_master 
                           WHERE  source_table = '160') y 
                           WHERE  x.key_seq = y.key_seq 
                           AND x.seq_no = y.seq_no) a, 
                           #mapping_table b 
                           WHERE  LEFT(a.div_cd, 5) = b.source_code
                           ")
        SqlMappied60T <- SqlRender::render(SqlMappied60T,
                                           NHISNSC_rawdata = NHISNSC_rawdata,
                                           NHISNSC_database = NHISNSC_database,
                                           NHIS_60T = NHIS_60T)
        ConvertedProcCountByMappied60T <<- DatabaseConnector::querySql(connection,SqlMappied60T)
        
        ## 60T Dup Mappied
        SqlDupMappied60T <- c("
                              SELECT Count(*) as count -- 5 
                              FROM   (SELECT x.div_cd, x.div_type_cd 
                              FROM   (SELECT * 
                              FROM   @NHISNSC_rawdata.@NHIS_60T 
                              WHERE  div_type_cd IN ( '1', '2' )) x, 
                              (SELECT *
                              FROM   @NHISNSC_database.seq_master 
                              WHERE  source_table = '160') y 
                              WHERE  x.key_seq = y.key_seq 
                              AND x.seq_no = y.seq_no) a, 
                              #duplicated b 
                              WHERE  LEFT(a.div_cd, 5) = b.source_code 
                              ")
        SqlDupMappied60T <- SqlRender::render(SqlDupMappied60T,
                                              NHISNSC_rawdata = NHISNSC_rawdata,
                                              NHISNSC_database = NHISNSC_database,
                                              NHIS_60T = NHIS_60T)
        ConvertedProcCountByDupMappied60T <<- DatabaseConnector::querySql(connection,SqlDupMappied60T)
        
        ## 60T UnMappied
        SqlUnMappied <- c("
                          SELECT Count(*) as count -- 25,286
                          FROM   (SELECT x.div_cd, x.div_type_cd 
                          FROM   (SELECT * 
                          FROM   @NHISNSC_rawdata.@NHIS_60T 
                          WHERE  div_type_cd IN ( '1', '2' )) x, 
                          (SELECT *
                          FROM   @NHISNSC_database.seq_master 
                          WHERE  source_table = '160') y 
                          WHERE  x.key_seq = y.key_seq 
                          AND x.seq_no = y.seq_no) a 
                          WHERE  LEFT(a.div_cd, 5) NOT IN (SELECT source_code 
                          FROM   #duplicated 
                          UNION ALL 
                          SELECT source_code 
                          FROM   #mapping_table)
                          ")
        SqlUnMappied <- SqlRender::render(SqlUnMappied,
                                          NHISNSC_rawdata = NHISNSC_rawdata,
                                          NHISNSC_database = NHISNSC_database,
                                          NHIS_60T = NHIS_60T)
        ConvertedProcCountByUnMappied60T <<- DatabaseConnector::querySql(connection,SqlUnMappied)
        
        ## 60T Raw
        SqlRawToProcBy60T_1 <- c("
                                 SELECT div_type_cd, multimappied, Count(*) AS COUNT, 'Y' AS MAPPING_YN
                                 FROM   (SELECT key_seq, seq_no, div_type_cd, Count(*) AS multimappied 
                                 FROM   (SELECT * 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_60T 
                                 WHERE  div_type_cd NOT IN ( '3', '4', '5', '7', '8' )) a, #mapping_table b 
                                 WHERE  LEFT(a.div_cd, 5) = b.source_code) c 
                                 GROUP  BY key_seq, seq_no, div_type_cd) d 
                                 GROUP  BY div_type_cd, multimappied 
                                 ")
        SqlRawToProcBy60T_1 <- SqlRender::render(SqlRawToProcBy60T_1,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_60T = NHIS_60T)
        SqlRawToProcBy60T_2 <- c("
                                 SELECT div_type_cd, multimappied, Count(*) AS COUNT, 'Y' AS MAPPING_YN 
                                 FROM   (SELECT key_seq, seq_no, div_type_cd, Count(*) AS multimappied 
                                 FROM   (SELECT * 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_60T 
                                 WHERE  div_type_cd IN ( '1', '2' )) a, #duplicated b 
                                 WHERE  LEFT(a.div_cd, 5) = b.source_code) c 
                                 GROUP  BY key_seq, seq_no, div_type_cd) d 
                                 GROUP  BY div_type_cd, multimappied 
                                 ")
        SqlRawToProcBy60T_2 <- SqlRender::render(SqlRawToProcBy60T_2,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_60T = NHIS_60T)
        SqlRawToProcBy60T_3 <- c("
                                 SELECT div_type_cd, multimappied, Count(*) AS COUNT, 'N' AS MAPPING_YN 
                                 FROM   (SELECT key_seq, seq_no, div_type_cd, Count(*) AS multimappied 
                                 FROM   (SELECT * 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_60T 
                                 WHERE  div_type_cd IN ( '1', '2' )) a
                                 WHERE  LEFT(a.div_cd, 5) NOT IN (SELECT source_code FROM #duplicated UNION ALL SELECT source_code FROM #mapping_table)) c 
                                 GROUP  BY key_seq, seq_no, div_type_cd) d 
                                 GROUP  BY div_type_cd, multimappied 
                                 ")
        SqlRawToProcBy60T_3 <- SqlRender::render(SqlRawToProcBy60T_3,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_60T = NHIS_60T)
        HowManyContainProcByMappied60T <- DatabaseConnector::querySql(connection,SqlRawToProcBy60T_1)
        HowManyContainProcByMappied60T <- rbind(HowManyContainProcByMappied60T,DatabaseConnector::querySql(connection,SqlRawToProcBy60T_2))
        HowManyContainProcByMappied60T <<- rbind(HowManyContainProcByMappied60T,DatabaseConnector::querySql(connection,SqlRawToProcBy60T_3))
        
    }
    
    
    
    
    ## Device_exposure
    if(device_exposure){
        
        ## Mapping Table
        SqlMapping <- c("
                        IF OBJECT_ID('tempdb..#mapping_table', 'U') IS NOT NULL
                        DROP TABLE #mapping_table;
                        IF OBJECT_ID('tempdb..#temp', 'U') IS NOT NULL
                        DROP TABLE #temp;
                        IF OBJECT_ID('tempdb..#duplicated', 'U') IS NOT NULL
                        DROP TABLE #duplicated;
                        IF OBJECT_ID('tempdb..#device', 'U') IS NOT NULL
                        DROP TABLE #device;
                        IF OBJECT_ID('tempdb..#five', 'U') IS NOT NULL
                        DROP TABLE #five;
                        
                        select a.source_code, a.target_concept_id, a.domain_id, REPLACE(a.invalid_reason, '', NULL) as invalid_reason
                        into #temp
                        from @Mapping_database.source_to_concept_map a join @Mapping_database.CONCEPT b on a.target_concept_id=b.concept_id
                        where a.invalid_reason is null and b.invalid_reason is null and a.domain_id='device';
                        
                        select * into #device from @Mapping_database.source_to_concept_map where domain_id='device';
                        select * into #five from @Mapping_database.source_to_concept_map where domain_id='procedure';
                        
                        select a.*
                        into #duplicated
                        from #device a, #five b
                        where a.source_code=b.source_code
                        and a.invalid_reason is null and b.invalid_reason is null;
                        
                        select * into #mapping_table from #temp
                        where source_code not in (select source_code from #duplicated);
                        
                        drop table #device, #five, #temp;
                        ")
        SqlMapping <- SqlRender::render(SqlMapping,Mapping_database = Mapping_database)
        DatabaseConnector::executeSql(connection,SqlMapping)
        
        
        ## 30T Mappied
        SqlMappied30T <- c("
                           SELECT Count(*) as count -- 7,886,009
                           FROM   (SELECT x.key_seq, x.div_cd 
                           FROM   (SELECT * 
                           FROM   @NHISNSC_rawdata.@NHIS_30T 
                           WHERE  div_type_cd NOT IN ( '1', '2', '3', '4', '5' )) x, 
                           @NHISNSC_database.seq_master y 
                           WHERE  y.source_table = '130' 
                           AND x.key_seq = y.key_seq 
                           AND x.seq_no = y.seq_no) a 
                           JOIN #mapping_table b 
                           ON a.div_cd = b.source_code; 
                           ")
        SqlMappied30T <- SqlRender::render(SqlMappied30T,
                                           NHISNSC_rawdata = NHISNSC_rawdata,
                                           NHISNSC_database = NHISNSC_database,
                                           NHIS_30T = NHIS_30T)
        ConvertedDeviCountByMappied30T <<- DatabaseConnector::querySql(connection,SqlMappied30T)
        
        ## 30T Dup Mappied
        SqlDupMappied30T <- c("
                              SELECT Count(*) as count --1,016
                              FROM   (SELECT x.key_seq, 
                              x.div_cd 
                              FROM   (SELECT * 
                              FROM   @NHISNSC_rawdata.@NHIS_30T 
                              WHERE  div_type_cd IN ( '7', '8' )) x, 
                              @NHISNSC_database.seq_master y 
                              WHERE  y.source_table = '130' 
                              AND x.key_seq = y.key_seq 
                              AND x.seq_no = y.seq_no) a 
                              JOIN #duplicated b 
                              ON a.div_cd = b.source_code
                              ")
        SqlDupMappied30T <- SqlRender::render(SqlDupMappied30T,
                                              NHISNSC_rawdata = NHISNSC_rawdata,
                                              NHISNSC_database = NHISNSC_database,
                                              NHIS_30T = NHIS_30T)
        ConvertedDeviCountByDupMappied30T <<- DatabaseConnector::querySql(connection,SqlDupMappied30T)
        
        ## 30T UnMappied
        SqlUnMappied <- c("
                          SELECT Count(*) as count -- 3,493,993
                          FROM   (SELECT x.key_seq, 
                          x.div_cd 
                          FROM   (SELECT * 
                          FROM   @NHISNSC_rawdata.@NHIS_30T 
                          WHERE  div_type_cd IN ( '7', '8' )) x, 
                          @NHISNSC_database.seq_master y 
                          WHERE  y.source_table = '130' 
                          AND x.key_seq = y.key_seq 
                          AND x.seq_no = y.seq_no) a 
                          WHERE  a.div_cd NOT IN (SELECT source_code 
                          FROM   #duplicated 
                          UNION ALL 
                          SELECT source_code 
                          FROM   #mapping_table); 
                          ")
        SqlUnMappied <- SqlRender::render(SqlUnMappied,
                                          NHISNSC_rawdata = NHISNSC_rawdata,
                                          NHISNSC_database = NHISNSC_database,
                                          NHIS_30T = NHIS_30T)
        ConvertedDeviCountByUnMappied30T <<- DatabaseConnector::querySql(connection,SqlUnMappied)
        
        ## 30T Raw
        SqlRawToDeviBy30T_1 <- c("
                                 SELECT div_type_cd, multimappied, Count(*) AS COUNT, 'Y' AS MAPPING_YN 
                                 from (select key_seq, seq_no, div_type_cd, count(*) as multimappied
                                 FROM   (SELECT * 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_30T 
                                 WHERE  div_type_cd NOT IN ( '1', '2', '3', '4', '5' )) x 
                                 JOIN #mapping_table y -- 1:1 mapping 
                                 ON x.div_cd = y.source_code) z 
                                 group by key_seq, seq_no, div_type_cd) a
                                 group by div_type_cd, multimappied
                                 ")
        SqlRawToDeviBy30T_1 <- SqlRender::render(SqlRawToDeviBy30T_1,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_30T = NHIS_30T)
        SqlRawToDeviBy30T_2 <- c("
                                 SELECT div_type_cd, 1 as multimappied, Count(*) AS COUNT, 'Y' AS MAPPING_YN 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_30T 
                                 WHERE  div_type_cd IN ( '7', '8' )) x JOIN #duplicated b
                                 GROUP  BY div_type_cd 
                                 ")
        SqlRawToDeviBy30T_2 <- SqlRender::render(SqlRawToDeviBy30T_2,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_30T = NHIS_30T)
        SqlRawToDeviBy30T_3 <- c("
                                 SELECT div_type_cd, 1 as multimappied, Count(*) AS COUNT, 'N' AS MAPPING_YN 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_30T 
                                 WHERE  div_type_cd IN ( '7', '8' )
                                 AND    div_cd not in (select source_code from #duplicated union all select source_code from #mapping_table)) x
                                 GROUP  BY div_type_cd 
                                 ")
        SqlRawToDeviBy30T_3 <- SqlRender::render(SqlRawToDeviBy30T_3,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_30T = NHIS_30T)
        HowManyContainDeviByMappied30T <- DatabaseConnector::querySql(connection,SqlRawToDeviBy30T_1)
        HowManyContainDeviByMappied30T <<- rbind(HowManyContainDeviByMappied30T,DatabaseConnector::querySql(connection,SqlRawToDeviBy30T_2))
        HowManyContainDeviByMappied30T <<- rbind(HowManyContainDeviByMappied30T,DatabaseConnector::querySql(connection,SqlRawToDeviBy30T_3))
        
        
        ## 60T Mappied
        SqlMappied60T <- c("
                           SELECT Count(*) as count -- 2
                           FROM   (SELECT x.key_seq, x.div_cd 
                           FROM   (SELECT * 
                           FROM   @NHISNSC_rawdata.@NHIS_60T 
                           WHERE  div_type_cd NOT IN ( '1', '2', '3', '4', '5' )) x, 
                           @NHISNSC_database.seq_master y 
                           WHERE  y.source_table = '160' 
                           AND x.key_seq = y.key_seq 
                           AND x.seq_no = y.seq_no) a 
                           JOIN #mapping_table b 
                           ON a.div_cd = b.source_code;  
                           ")
        SqlMappied60T <- SqlRender::render(SqlMappied60T,
                                           NHISNSC_rawdata = NHISNSC_rawdata,
                                           NHISNSC_database = NHISNSC_database,
                                           NHIS_60T = NHIS_60T)
        ConvertedDeviCountByMappied60T <<- DatabaseConnector::querySql(connection,SqlMappied60T)
        
        ## 60T Dup Mappied
        SqlDupMappied60T <- c("
                              SELECT Count(*) as count -- 0
                              FROM   (SELECT x.key_seq, 
                              x.div_cd 
                              FROM   (SELECT * 
                              FROM   @NHISNSC_rawdata.@NHIS_60T 
                              WHERE  div_type_cd IN ( '7', '8' )) x, 
                              @NHISNSC_database.seq_master y 
                              WHERE  y.source_table = '160' 
                              AND x.key_seq = y.key_seq 
                              AND x.seq_no = y.seq_no) a 
                              JOIN #duplicated b 
                              ON a.div_cd = b.source_code 
                              ")
        SqlDupMappied60T <- SqlRender::render(SqlDupMappied60T,
                                              NHISNSC_rawdata = NHISNSC_rawdata,
                                              NHISNSC_database = NHISNSC_database,
                                              NHIS_60T = NHIS_60T)
        ConvertedDeviCountByDupMappied60T <<- DatabaseConnector::querySql(connection,SqlDupMappied60T)
        
        ## 60T UnMappied
        SqlUnMappied <- c("
                          SELECT Count(*) as count -- 795
                          FROM   (SELECT x.key_seq, 
                          x.div_cd 
                          FROM   (SELECT * 
                          FROM   @NHISNSC_rawdata.@NHIS_60T 
                          WHERE  div_type_cd IN ( '7', '8' )) x, 
                          @NHISNSC_database.seq_master y 
                          WHERE  y.source_table = '160' 
                          AND x.key_seq = y.key_seq 
                          AND x.seq_no = y.seq_no) a 
                          WHERE  a.div_cd NOT IN (SELECT source_code 
                          FROM   #duplicated 
                          UNION ALL 
                          SELECT source_code 
                          FROM   #mapping_table);
                          ")
        SqlUnMappied <- SqlRender::render(SqlUnMappied,
                                          NHISNSC_rawdata = NHISNSC_rawdata,
                                          NHISNSC_database = NHISNSC_database,
                                          NHIS_60T = NHIS_60T)
        ConvertedDeviCountByUnMappied60T <<- DatabaseConnector::querySql(connection,SqlUnMappied)
        
        ## 60T Raw
        SqlRawToDeviBy60T_1 <- c("
                                 SELECT div_type_cd, multimappied, Count(*) AS COUNT, 'Y' AS MAPPING_YN  
                                 from (select key_seq, seq_no, div_type_cd, count(*) as multimappied
                                 FROM   (SELECT * 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_60T 
                                 WHERE  div_type_cd NOT IN ( '1', '2', '3', '4', '5' )) x 
                                 JOIN #mapping_table y -- 1:1 mapping 
                                 ON x.div_cd = y.source_code) z 
                                 group by key_seq, seq_no, div_type_cd) a
                                 group by div_type_cd, multimappied
                                 ")
        SqlRawToDeviBy60T_1 <- SqlRender::render(SqlRawToDeviBy60T_1,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_60T = NHIS_60T)
        SqlRawToDeviBy60T_2 <- c("
                                 SELECT div_type_cd, 1 as multimappied, Count(*) AS COUNT, 'Y' AS MAPPING_YN 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_60T 
                                 WHERE  div_type_cd IN ( '7', '8' )) x JOIN #duplicated b 
                                 GROUP  BY div_type_cd 
                                 ")
        SqlRawToDeviBy60T_2 <- SqlRender::render(SqlRawToDeviBy60T_2,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_60T = NHIS_60T)
        SqlRawToDeviBy60T_3 <- c("
                                 SELECT div_type_cd, 1 as multimappied, Count(*) AS COUNT, 'N' AS MAPPING_YN 
                                 FROM   (SELECT * 
                                 FROM   @NHISNSC_rawdata.@NHIS_60T 
                                 WHERE  div_type_cd IN ( '7', '8' )
                                 AND    div_cd not in (select source_code from #duplicated union all select source_code from #mapping_table)) x
                                 GROUP  BY div_type_cd 
                                 ")
        SqlRawToDeviBy60T_3 <- SqlRender::render(SqlRawToDeviBy60T_3,
                                                 NHISNSC_rawdata = NHISNSC_rawdata,
                                                 NHIS_60T = NHIS_60T)
        HowManyContainDeviByMappied60T <- DatabaseConnector::querySql(connection,SqlRawToDeviBy60T_1)
        HowManyContainDeviByMappied60T <<- rbind(HowManyContainDeviByMappied60T,DatabaseConnector::querySql(connection,SqlRawToDeviBy60T_2))
        HowManyContainDeviByMappied60T <<- rbind(HowManyContainDeviByMappied60T,DatabaseConnector::querySql(connection,SqlRawToDeviBy60T_3))
        
    } ## DeviceTable : 20T join으로 인해 2건 차이남
    
    
    
    
    if(condition_occurrence){
        
        ## Mapping Table
        SqlMapping <- c("
                        IF OBJECT_ID('tempdb..#mapping_table', 'U') IS NOT NULL
                        DROP TABLE #mapping_table;
                        IF OBJECT_ID('tempdb..#mapping_table2', 'U') IS NOT NULL
                        DROP TABLE #mapping_table2;
                        select a.source_code, a.target_concept_id, a.domain_id, REPLACE(a.invalid_reason, '', NULL) as invalid_reason
                        into #mapping_table
                        from @Mapping_database.source_to_concept_map a join @Mapping_database.CONCEPT b on a.target_concept_id=b.concept_id
                        where a.invalid_reason is null and b.invalid_reason is null and a.domain_id='condition';
                        
                        select a.source_code, a.target_concept_id, a.domain_id, REPLACE(a.invalid_reason, '', NULL) as invalid_reason
                        into #mapping_table2
                        from @Mapping_database.source_to_concept_map a join @Mapping_database.CONCEPT b on a.target_concept_id=b.concept_id
                        where a.invalid_reason is null and b.invalid_reason is null;
                        ")
        SqlMapping <- SqlRender::render(SqlMapping,Mapping_database = Mapping_database)
        DatabaseConnector::executeSql(connection,SqlMapping)
        
        
        ## 40T Mappied
        SqlMappied40T <- c("
                           select count(*) as count from (select a.person_id, sick_sym -- 292,249,453
                           from (select * from @NHISNSC_database.SEQ_MASTER where source_table='140') a,
                           @NHISNSC_rawdata.@NHIS_20T b,
                           @NHISNSC_rawdata.@NHIS_40T c
                           where a.person_id=b.person_id
                           and a.key_seq=b.key_seq
                           and a.key_seq=c.key_seq
                           and a.seq_no=c.seq_no) as m,
                           #mapping_table as n
                           where m.sick_sym=n.source_code;
                           ")
        SqlMappied40T <- SqlRender::render(SqlMappied40T,
                                           NHISNSC_rawdata = NHISNSC_rawdata,
                                           NHISNSC_database = NHISNSC_database,
                                           NHIS_20T = NHIS_20T,
                                           NHIS_40T = NHIS_40T)
        ConvertedCondiCountByMappied40T <<- DatabaseConnector::querySql(connection,SqlMappied40T)
        
        ## 40T UnMappied
        SqlUnMappied40T <- c("
                             select count(*) as count from (select a.person_id, sick_sym -- 7,176,297
                             from (select * from @NHISNSC_database.SEQ_MASTER where source_table='140') a, 
                             @NHISNSC_rawdata.@NHIS_20T b, 
                             @NHISNSC_rawdata.@NHIS_40T c
                             where a.person_id=b.person_id
                             and a.key_seq=b.key_seq
                             and a.key_seq=c.key_seq
                             and a.seq_no=c.seq_no) as m
                             where m.sick_sym not in (select source_code from #mapping_table2)
                             ")
        SqlUnMappied40T <- SqlRender::render(SqlUnMappied40T,
                                             NHISNSC_rawdata = NHISNSC_rawdata,
                                             NHISNSC_database = NHISNSC_database,
                                             NHIS_20T = NHIS_20T,
                                             NHIS_40T = NHIS_40T)
        ConvertedCondiCountByUnMappied40T <<- DatabaseConnector::querySql(connection,SqlUnMappied40T)
        
        ## 40T Raw
        SqlRawToCondiBy40T_1 <- c("
                                  SELECT domain_id, multimappied, Count(*) AS COUNT, 'Y' AS MAPPING_YN 
                                  FROM   (SELECT key_seq, seq_no, domain_id, Count(*) AS multimappied 
                                  FROM   (SELECT * 
                                  FROM   @NHISNSC_rawdata.@NHIS_40T a 
                                  JOIN #mapping_table2 b ON a.sick_sym = b.source_code 
                                  WHERE  b.domain_id = 'condition') c -- 1:n mappied  292,250,891   
                                  GROUP  BY key_seq, seq_no, domain_id) d 
                                  GROUP  BY domain_id, multimappied  
                                  ")
        SqlRawToCondiBy40T_1 <- SqlRender::render(SqlRawToCondiBy40T_1,
                                                  NHISNSC_rawdata = NHISNSC_rawdata,
                                                  NHIS_40T = NHIS_40T)
        SqlRawToCondiBy40T_2 <- c("
                                  SELECT 'Unclassified' as domain_id, 1 as multimappied, Count(*) AS COUNT, 'N' AS MAPPING_YN
                                  FROM   @NHISNSC_rawdata.@NHIS_40T 
                                  WHERE  sick_sym NOT IN (SELECT source_code FROM #mapping_table2) 
                                  ")
        SqlRawToCondiBy40T_2 <- SqlRender::render(SqlRawToCondiBy40T_2,
                                                  NHISNSC_rawdata = NHISNSC_rawdata,
                                                  NHIS_40T = NHIS_40T)
        HowManyContainCondiByMappied40T <- DatabaseConnector::querySql(connection,SqlRawToCondiBy40T_1)
        HowManyContainCondiByMappied40T <<- rbind(HowManyContainCondiByMappied40T,DatabaseConnector::querySql(connection,SqlRawToCondiBy40T_2))
        
    } ## ConditionOccurrenceTable : 20T join으로 인해 3건 차이남, 기간 제거 개수 확인요망
    
    
    
    
    if(measurement){
        
        ## Mapping Table
        SqlMapping <- c("
                        IF OBJECT_ID('tempdb..#measurement_mapping', 'U') IS NOT NULL
                        DROP TABLE #measurement_mapping;
                        CREATE TABLE #measurement_mapping
                        (
                        meas_type					varchar(50)					NULL , 
                        id_value					varchar(50)					NULL ,
                        answer						bigint						NULL ,
                        measurement_concept_id		bigint						NULL ,
                        measurement_type_concept_id	bigint						NULL ,
                        measurement_unit_concept_id	bigint						NULL ,
                        value_as_concept_id			bigint						NULL ,
                        value_as_number				float						NULL 
                        )
                        ;
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('HEIGHT',			'01',	0,	3036277,	44818701,	4122378,	NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('WEIGHT',			'02',	0,	3025315,	44818701,	4122383,	NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('WAIST',				'03',	0,	3016258,	44818701,	4122378,	NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('BP_HIGH',			'04',	0,	3028737,	44818701,	4118323,	NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('BP_LWST',			'05',	0,	3012888,	44818701,	4118323,	NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('BLDS',				'06',	0,	46235168,	44818702,	4121396,	NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('TOT_CHOLE',			'07',	0,	3027114,	44818702,	4121396,	NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('TRIGLYCERIDE',		'08',	0,	3022038,	44818702,	4121396,	NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('HDL_CHOLE',			'09',	0,	3023752,	44818702,	4121396,	NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('LDL_CHOLE',			'10',	0,	3028437,	44818702,	4121396,	NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('HMG',				'11',	0,	3000963,	44818702,	4121395,	NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('GLY_CD',			'12',	1,	3009261,	44818702,	NULL,		9189,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('GLY_CD',			'12',	2,	3009261,	44818702,	NULL,		4127785,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('GLY_CD',			'12',	3,	3009261,	44818702,	NULL,		4123508,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('GLY_CD',			'12',	4,	3009261,	44818702,	NULL,		4126673,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('GLY_CD',			'12',	5,	3009261,	44818702,	NULL,		4125547,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('GLY_CD',			'12',	6,	3009261,	44818702,	NULL,		4126674,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('OLIG_OCCU_CD',		'13',	1,	437038,		44818702,	NULL,		9189,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('OLIG_OCCU_CD',		'13',	2,	437038,		44818702,	NULL,		4127785,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('OLIG_OCCU_CD',		'13',	3,	437038,		44818702,	NULL,		4123508,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('OLIG_OCCU_CD',		'13',	4,	437038,		44818702,	NULL,		4126673,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('OLIG_OCCU_CD',		'13',	5,	437038,		44818702,	NULL,		4125547,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('OLIG_OCCU_CD',		'13',	6,	437038,		44818702,	NULL,		4126674,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('OLIG_PH',			'14',	0,	3015736,	44818702,	8482,		NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('OLIG_PROTE_CD',		'15',	1,	3014051,	44818702,	NULL,		9189,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('OLIG_PROTE_CD',		'15',	2,	3014051,	44818702,	NULL,		4127785,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('OLIG_PROTE_CD',		'15',	3,	3014051,	44818702,	NULL,		4123508,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('OLIG_PROTE_CD',		'15',	4,	3014051,	44818702,	NULL,		4126673,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('OLIG_PROTE_CD',		'15',	5,	3014051,	44818702,	NULL,		4125547,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('OLIG_PROTE_CD',		'15',	6,	3014051,	44818702,	NULL,		4126674,	NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('CREATININE',		'16',	0,	2212294,	44818702,	4121396,	NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('SGOT_AST',			'17',	0,	2212597,	44818702,	4118000,	NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('SGPT_ALT',			'18',	0,	2212598,	44818702,	4118000,	NULL,		NULL)
                        insert into #measurement_mapping (meas_type, id_value, answer, measurement_concept_id, measurement_type_concept_id, measurement_unit_concept_id, value_as_concept_id, value_as_number) values ('GAMMA_GTP',			'19',	0,	4289475,	44818702,	4118000,	NULL,		NULL)
                        ")
        DatabaseConnector::executeSql(connection,SqlMapping)
        
        
        ## GJ 수치형
        SqlMappiedGJ_num <- c("
                              SELECT Count(*) as COUNT -- 29,145,003
                              FROM   (SELECT a.meas_type, meas_value, hchk_year, person_id 
                              FROM   @NHISNSC_rawdata.gj_vertical a, -- left join 75,717,081, 원래 75,298,684 -> 1:n mappig
                              #measurement_mapping b 
                              where  Isnull(a.meas_type, '') = Isnull(b.meas_type, '') 
                              AND Isnull(a.meas_value, '0') >= Isnull(Cast(b.answer AS CHAR), '0')) c, --  33,858,848 -> 1:1 mapping
                              @NHISNSC_rawdata.@NHIS_GJ d 
                              where  c.person_id = Cast(d.person_id AS CHAR) 
                              AND c.hchk_year = d.hchk_year 
                              AND c.meas_value != '' 
                              AND Substring(c.meas_type, 1, 30) IN ( 
                              'HEIGHT', 'WEIGHT', 'WAIST', 'BP_HIGH', 'BP_LWST', 'BLDS', 'TOT_CHOLE', 'TRIGLYCERIDE', 
                              'HDL_CHOLE', 'LDL_CHOLE', 'HMG', 'OLIG_PH', 'CREATININE', 'SGOT_AST', 'SGPT_ALT', 'GAMMA_GTP' ) 
                              ")
        SqlMappiedGJ_num <- SqlRender::render(SqlMappiedGJ_num,
                                              NHISNSC_rawdata = NHISNSC_rawdata,
                                              NHIS_GJ = NHIS_GJ)
        ConvertedMeasuCountByMappiedGJ_num <<- DatabaseConnector::querySql(connection,SqlMappiedGJ_num)
        
        ## GJ 코드형
        SqlMappiedGJ_code <- c("
                               SELECT Count(*) as COUNT -- 4,295,448
                               FROM   (SELECT a.meas_type, meas_value, hchk_year, person_id 
                               FROM   @NHISNSC_rawdata.gj_vertical a, -- left join 75,298,684, 원래 75,298,684 -> 1:1 mappig
                               #measurement_mapping b 
                               where  Isnull(a.meas_type, '') = Isnull(b.meas_type, '') 
                               AND Isnull(a.meas_value, '0') = Isnull(Cast(b.answer AS CHAR), '0')) c, --  -> 1:1 mapping
                               @NHISNSC_rawdata.@NHIS_GJ d 
                               where   c.person_id = Cast(d.person_id AS CHAR) 
                               AND c.hchk_year = d.hchk_year 
                               AND c.meas_value != '' 
                               AND Substring(c.meas_type, 1, 30) IN ( 'GLY_CD', 'OLIG_OCCU_CD', 'OLIG_PROTE_CD' ) 
                               ")
        SqlMappiedGJ_code <- SqlRender::render(SqlMappiedGJ_code,
                                               NHISNSC_rawdata = NHISNSC_rawdata,
                                               NHIS_GJ = NHIS_GJ)
        ConvertedMeasuCountByMappiedGJ_code <<- DatabaseConnector::querySql(connection,SqlMappiedGJ_code)
        
        
    } 
    
}
```





### DQ Function EXE

```{r, echo=FALSE}
connectionDetails <- DatabaseConnector::createConnectionDetails(
    dbms = 'sql server'
    , server = Sys.getenv("myCdmServer")
    , schema = Sys.getenv("myCdmSchema")
    , user = Sys.getenv("userId")
    , password = Sys.getenv("password")
)
DatabaseConnector::connect(connectionDetails = connectionDetails)
connection <- DatabaseConnector::connect(connectionDetails)
NHISNSC_rawdata <- "nhisnsc2013original.dbo"
Mapping_database <- "NHIS_NSC_NEW_MAPPING.dbo"
NHISNSC_database <- "NHIS_NSC_v5_3_1.dbo"
NHIS_20T <- "NHID_GY20_T1"
NHIS_30T <- "NHID_GY30_T1"
NHIS_40T <- "NHID_GY40_T1"
NHIS_60T <- "NHID_GY60_T1"
NHIS_GJ <- "NHID_GJ"
NHIS_JK <- "NHID_JK"

DQevaluation(NHISNSC_rawdata,
             NHISNSC_database,
             Mapping_database,
             NHIS_JK,
             NHIS_20T,
             NHIS_30T,
             NHIS_40T,
             NHIS_60T,
             NHIS_GJ,
             
             connection,
             
             drug_exposure = TRUE,
             procedure_occurrence = TRUE,
             device_exposure = TRUE,
             condition_occurrence = TRUE,
             measurement = TRUE)
```




### Drug DQ 


## Converted data to Drug
* 'Seq_Master'와 'Join'하여 'Drug Table'에 적재될 데이터 개수 (기간 및 클랜징 제거 이전 개수)

```{r}
ConvertedDrugCountByMappied30T;
```


```{r}
ConvertedDrugCountByUnMappied30T;
```


```{r}
ConvertedDrugCountByMappied60T;
```


```{r}
ConvertedDrugCountByUnMappied60T;
```


* 총 합
```{r}
sum(ConvertedDrugCountByMappied30T$COUNT, ConvertedDrugCountByUnMappied30T$COUNT, ConvertedDrugCountByMappied60T$COUNT, ConvertedDrugCountByUnMappied60T$COUNT)
```


## Raw data Drug
* 원본 데이터(ex 30T,40T,60T)에서 항목 분류 후, 'Drug Table'에 적재될 개수
* 'Drug'의 경우 'DIV_TYPE_CD' '3','4','5'에 'mapping'과 'unmapping'이 섞여있음, 그 외 항목은 'mapping'된 값임
* 'Unmapping'의 경우 아래표에서 'MULTIMAPPIED' 값을 '1'로 줌 (계산의 편의성을 위해)

```{r}
HowManyContainDrugByMappied30T;
```


```{r}
HowManyContainDrugByMappied60T;
```
 

* 총 합
```{r}
sum((HowManyContainDrugByMappied30T$COUNT*HowManyContainDrugByMappied30T$MULTIMAPPIED), (HowManyContainDrugByMappied60T$COUNT*HowManyContainDrugByMappied60T$MULTIMAPPIED))
```



### Procedure DQ
* 40T 데이터 미반영 (추가 예정)


## Converted data to Procedure
* 'Seq_Master'와 'Join'하여 'Procedure Table'에 적재될 데이터 개수 (기간 및 클랜징 제거 이전 개수)
* 'Duplicated Mapping Table'은 'Procedure'와 'Device' 소스코드가 같은 경우

```{r}
ConvertedProcCountByMappied30T;
```


```{r}
ConvertedProcCountByDupMappied30T;
```


```{r}
ConvertedProcCountByUnMappied30T;
```


```{r}
ConvertedProcCountByMappied60T;
```


```{r}
ConvertedProcCountByDupMappied60T;
```


```{r}
ConvertedProcCountByUnMappied60T;
```

* 총 합
```{r}
sum(ConvertedProcCountByMappied30T$COUNT, ConvertedProcCountByDupMappied30T$COUNT, ConvertedProcCountByUnMappied30T$COUNT, ConvertedProcCountByMappied60T$COUNT, ConvertedProcCountByDupMappied60T$COUNT, ConvertedProcCountByUnMappied60T$COUNT)
```


## Raw data Procedure
* 원본 데이터(ex 30T,40T,60T)에서 항목 분류 후, 'Procedure Table'에 적재될 개수
* 'Procedure'의 경우 'MAPPING_YN' 컬럼을 통해 mapping 유/무 파악 가능
* 'Unmapping'의 경우 아래표에서 'MULTIMAPPIED' 값을 '1'로 줌 (계산의 편의성을 위해)

```{r}
HowManyContainProcByMappied30T;
```


```{r}
HowManyContainProcByMappied60T;
```


* 총 합
```{r}
sum((HowManyContainProcByMappied30T$COUNT*HowManyContainProcByMappied30T$MULTIMAPPIED), (HowManyContainProcByMappied60T$COUNT*HowManyContainProcByMappied60T$MULTIMAPPIED))
```




### Device DQ


## Converted data to Device
* 'Seq_Master'와 'Join'하여 'Device Table'에 적재될 데이터 개수 (기간 및 클랜징 제거 이전 개수)
* 'Duplicated Mapping Table'은 'Device'와 'Drug' 소스코드가 같은 경우

```{r}
ConvertedDeviCountByMappied30T;
```


```{r}
ConvertedDeviCountByDupMappied30T;
```


```{r}
ConvertedDeviCountByUnMappied30T;
```


```{r}
ConvertedDeviCountByMappied60T;
```


```{r}
ConvertedDeviCountByDupMappied60T;
```


```{r}
ConvertedDeviCountByUnMappied60T;
```

* 총 합
```{r}
sum(ConvertedDeviCountByMappied30T$COUNT, ConvertedDeviCountByDupMappied30T$COUNT, ConvertedDeviCountByUnMappied30T$COUNT, ConvertedDeviCountByMappied60T$COUNT, ConvertedDeviCountByDupMappied60T$COUNT, ConvertedDeviCountByUnMappied60T$COUNT)
```


## Raw data Device
* 원본 데이터(ex 30T,40T,60T)에서 항목 분류 후, 'Device Table'에 적재될 개수
* 'Device'의 경우 'MAPPING_YN' 컬럼을 통해 mapping 유/무 파악 가능
* 'Unmapping'의 경우 아래표에서 'MULTIMAPPIED' 값을 '1'로 줌 (계산의 편의성을 위해)

```{r}
HowManyContainDeviByMappied30T;
```


```{r}
HowManyContainDeviByMappied60T;
```


* 총 합
```{r}
sum((HowManyContainDeviByMappied30T$COUNT*HowManyContainDeviByMappied30T$MULTIMAPPIED), (HowManyContainDeviByMappied60T$COUNT*HowManyContainDeviByMappied60T$MULTIMAPPIED))
```




### Condition DQ


## Converted data to Condition
* 'Seq_Master'와 'Join'하여 'Condition Table'에 적재될 데이터 개수 (기간 및 클랜징 제거 이전 개수)

```{r}
ConvertedCondiCountByMappied40T;
```


```{r}
ConvertedCondiCountByUnMappied40T;
```


* 총 합
```{r}
sum(ConvertedCondiCountByMappied40T$COUNT, ConvertedCondiCountByUnMappied40T$COUNT)
```


## Raw data Condition
* 원본 데이터(ex 30T,40T,60T)에서 항목 분류 후, 'Condition Table'에 적재될 개수
* 'Condition'의 경우 'DOMAIN_ID' 컬럼을 통해 mapping 유/무 파악 가능
* 'Unmapping'의 경우 아래표에서 'MULTIMAPPIED' 값을 '1'로 줌 (계산의 편의성을 위해)

```{r}
HowManyContainCondiByMappied40T;
```




### Measurement DQ


## Raw data Measurement
* 원본 데이터(ex 30T,40T,60T)에서 항목 분류 후, 'Measurement Table'에 적재될 개수
* 40T 데이터 미반영 (추가 예정)

```{r}
ConvertedMeasuCountByMappiedGJ_num;
```


```{r}
ConvertedMeasuCountByMappiedGJ_code;
```


* 총 합
```{r}
sum(ConvertedMeasuCountByMappiedGJ_num$COUNT,ConvertedMeasuCountByMappiedGJ_code$COUNT)
```